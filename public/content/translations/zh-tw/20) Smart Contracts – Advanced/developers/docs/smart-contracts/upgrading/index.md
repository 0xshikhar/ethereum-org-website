---
title: 升級智慧型合約
description: 以太坊智慧合約升級模式概述
lang: zh-tw
---

以太坊上的智慧型合約是在以太坊虛擬機器 (EVM) 中運行的自動執行程式。 這些程式在設計上是不可變的，一旦部署合約，就可以防止對業務邏輯進行任何更新。

當永恆不變在去信任化、去中心化和合約安全中是不可或缺的，卻可能在一些案例中變成缺點， 舉例來說，永恆不變的程式碼讓開發者無法修復有缺陷的合約。

越來越多改進合約的研究，引入了幾種升級合約的模式， 這些升級的模式讓開發者把商業邏輯拆出來放在不同的和合約使得合約可升級（在保持不可變的前提之下）。

## 先決條件 {#prerequisites}

需要對[智慧合約](/developers/docs/smart-contracts/)、[智慧合約剖析](/developers/docs/smart-contracts/anatomy/)和[以泰坊虛擬機(EVM)](/developers/docs/evm/)有一定程度的了解， 此文還假設讀者了解智慧合約的程式設計。

## 什麼是智慧合約升級？ {#what-is-a-smart-contract-upgrade}

合約升級代表在更換商業邏輯合約的同時保留合約狀態， 在智慧合約相關的文章中，要分清楚可升級與易變性是兩回事，

你依然無法改變已經部署在以太坊網路上的合約位置， 但是可以改變與使用者互動的合約所執行程式。

可以由以下幾個方法做到：

1. 建立多個版本的合約以及從舊合約遷移狀態（例如：資料）到新的實作合約

2. 將商業邏輯與狀態分別存放在不同合約

3. 用代理的模式呼叫方法，從不可變的合約委派到可以修改的邏輯合約

4. 建立一個不變的主合約作為介面，並依靠其他多個有彈性的衛星合約執行特定功能

5. 使用鑽石模式從代理合約委派函式呼叫到邏輯合約

### 升級機制 #1: 合約遷移 {#contract-migration}

合約遷移是建立在版本控制上—想法來自在相同的軟體上建立和管理唯一的狀態 合約轉移需要部署現有合約的新實例，並將存儲和餘額轉移到該新合約。

新部署的合約存儲為空，允許你從原有合約恢復資料並為其寫入新的實作。 此後，你將需要將所有與舊合約有互動的合約更新新的地址

合約遷移的最後一步是說服用戶轉去使用新合約。 新的合約版本將保留用戶餘額和地址，從而保持不變性。 如果是基於代幣的合約，你還需要聯繫交易所放棄舊合約並使用新合約。

合約遷徙是一個相對簡單且安全的合約升級方式，不會影響到使用者的互動， 手動遷徙使用者的儲存空間和餘額到新的合約是非常花時間且需要高gas成本，

[更多關於合約遷徙。](https://blog.trailofbits.com/2018/10/29/how-contract-migration-works/)

### 升級機制#2: 資料分離 {#data-separation}

其他升級合約的方式為：將“商業邏輯”與“資料儲存”分開到不同的合約 這代表使用者與邏輯合約互動的同時資料是儲存在“資料儲存合約”。

邏輯合約包含當使用者與應用程式互動時執行的程式碼， 以及資料儲存合約地址與資料合約互動來取得與新增資料。

同時，儲存合約保存與智慧合約相關的狀態，例如使用者餘額和地址。 請注意，儲存合約歸邏輯合約所有，並在部署時使用邏輯合約的地址作配置。 這可以防止未經授權的合約呼叫儲存合約或更新其資料。

首先，儲存合約是永久的—但是你可以換掉邏輯合約，將邏輯合約指向新的實作， 這樣可以換掉在EVM上執行的程式，同時原封不動的保有儲存空間以及餘額。

使用升級方法需要更新邏輯合約地址到儲存合約上， 同時需要在新的邏輯合約上設定儲存合約的地址，理由稍後說明。

資料分離模式可以說是相較於資料遷移更簡單的實作方法 然而，你將必須管理多個合約並實作複雜的授權方案，以此保護智慧合約不受惡意升級。

### 升級機制#3: 代理模式 {#proxy-patterns}

代理模式同時使用資料分離來確保商業邏輯與資料在不同合約， 然而，在代理模式下，儲存合約（或稱代理）在執行程式時呼叫邏輯合約， 這是一個相反的資料分離模式，在這裡的邏輯合約稱為儲存合約。

代理模式的流程：

1. 使用者與儲存資料的代理合約互動，但這個合約上沒有但這個合約上沒有商業邏輯

2. 代理合約存儲邏輯合約的地址，並使用 `delegatecall` 函數將所有函數呼叫委派給邏輯合約 (擁有商業邏輯的合約)

3. 在所有的呼叫轉給邏輯合約後，從邏輯合約回傳的資料會被擷取與回傳給使用者

用代理模式需要了解** delegatecall**方法， 簡單來講，`delegatecall` 是允許合約調用另一個合約的操作碼，而實際的程式碼執行發生在呼叫合約的情境下。 在代理模式中使用 `delegatecall` 的含義是，代理合約讀取和寫入其存儲空間並執行存儲在邏輯合約中的邏輯，就像呼叫一個内部函數一樣。

根據 [Solidity 文件](https://docs.soliditylang.org/en/latest/introduction-to-smart-contracts.html#delegatecall-callcode-and-libraries)：

> _存在一個訊息呼叫的特殊變數，稱爲 **delegatecall**，該變數與訊息呼叫相同，除了目標地址中的程式碼是在呼叫合約的情境下執行，以及 `msg.sende` 和 `msg.value` 不會改變它們的值。__這意味著合約可以在運行時從一個不同地址動態載入程式碼。 儲存空間、目前的地址和餘額仍然是指呼叫的合約，只有程式碼是來自被呼叫的地址。</p> </blockquote> 
> 
> 代理合約知道使用者呼叫方法時是呼叫`delegatecall`，因為有內建`fallback`函數。 在撰寫Solidity時，在呼叫不到相符的方法時[預設函式](https://docs.soliditylang.org/en/latest/contracts.html#fallback-function)會被觸發。
> 
> 要使代理模式正常運作，需要編寫指定代理合約應該如何處理其不支持函數的預設函式。 在這種情況下，代理的預設函式作為進入delegatecall和讓使用者的請求導到目前的邏輯合約。
> 
> 代理合約預設是不變的，但是邏輯合約可以更新成新的商業邏輯， 執行升級就是在更改代理合約中所使用的邏輯合約地址，
> 
> 將代理合約指向新的邏輯合約，當使用者呼叫代理合約時程式就會執行就會改變， 讓我們在升級合約邏輯時，不用詢問使用者要不要與新的合約互動。
> 
> 代理模式是一種升級智慧合約的熱門方法，因爲其消除了與合約遷移相關的困難。 然而，代理合約使用起來更加複雜，使用不當時可能帶來重大缺陷，例如[函數選擇器崩潰](https://medium.com/nomic-foundation-blog/malicious-backdoors-in-ethereum-proxies-62629adf3357)。
> 
> [更多關於代理模式](https://blog.openzeppelin.com/proxy-patterns/)
> 
> ### 升級機制#4: 策略模式 {#strategy-pattern}
> 
> 該技術受到[策略模式](https://en.wikipedia.org/wiki/Strategy_pattern)的影響，這種模式鼓勵建立與其他程式連結來實現特定功能的軟體。 在以太坊上使用策略模式開發意指建立一個呼叫其他合約方法的合約。
> 
> 在這個模式下，主要的合約包含邏輯合約，但與其他合約（衛星合約）介接來執行特定方法， 主合約儲存了各衛星合約的地址，可以在不同的衛星合約實作之間切換，
> 
> 可以建立一個新的衛星合約並在主合約上設定新的地址， 讓你可以更換_策略<0>合約（例如：實作新的合約）</p> 
> 
> 儘管與先前討論的代理模式類似，策略模式在主要合約上有所不同，該合約具有商業邏輯，與用戶互動。 使用這個模式提供合約一個有限度、不會影響到主要功能的改動機會。
> 
> 缺點是這種模式只適合小幅度的升級， 同時，當主合約受到波及（例如：被駭）時，你無法使用這種升級方法。
> 
> ### 升級機制 #5: 鑽石模式 {#diamond-pattern}
> 
> 最時模式被視為改良版的代理模式， 鑽石模式與代理模式不同的是鑽石代理合約可以委派不只一個邏輯合約。
> 
> 在鑽石模式中的邏輯合約被稱為_切面_， 為了使鑽石模式發揮作用，需要在代理合約中建立對應，將[函數選擇器](https://docs.soliditylang.org/en/latest/abi-spec.html#function-selector)對應到不同切面的地址。
> 
> 當使用者呼叫方法時，代理合約會找的負責的執行函數的切面， 因此` delegatecall`（使用預設函數）和重導到適合的邏輯合約，
> 
> 鑽石升級模式，有幾個優於傳同代理模式的好處：
> 
> 1. 不用更換掉所有的程式碼，只需要做部分升級， 使用代理模式升級，即便是只要做少部分升級，仍需要建立整份新的邏輯合約
> 
> 2. 所有智慧合約 (包括代理模式中使用的邏輯合約) 都有 24KB 的大小限制，這對於需要更多函數的複雜合約可能是一個限制。 鑽石模式藉由分散到函數到多個邏輯合約，簡單的解決了這個問題
> 
> 3. 代理模式採用了包羅萬象的權限管理方法， 一個有升級權限的實體可以置換_整個_合約 但鑽石模式支持模組化權限方法，你能夠限制實體升級智慧合約中的特定函數。
> 
> [更多關於鑽石模式](https://eip2535diamonds.substack.com/p/introduction-to-the-diamond-standard?s=w)
> 
> ## 升級智慧合約的利弊 {#pros-and-cons-of-upgrading-smart-contracts}
> 
>

| 優勢                                   | 劣勢                                     |
| ------------------------------------ | -------------------------------------- |
| 智慧合約升級使得已經部署過的合約可以簡單的修復漏洞            | 升級智慧合約讓程式碼的永恆性消失，會連帶影響到去中心化與安全         |
| 開發者可以使用邏輯合約新增功能到去中心化應用程式上            | 使用者必須相信開發者不會任意的修改程式碼                   |
| 智慧合約升級可以增進終端使用者的安全性，因為漏洞可以被快速修復      | 在智慧合約中編寫升級功能增加了另一層複雜性和出現重大缺陷的可能性。      |
| 合約升級給了開發者更多的空間去嘗試不同的功能並不斷地推進dApps的發展 | 升級智慧合約的機會可能會促使開發者在開發時未經充分檢查研究就快速發佈項目   |
|                                      | 智慧合約的不安全存取控制和中心化可能會使惡意行爲者更容易執行未經授權的升級。 |


## 升級合約的注意事項 {#considerations-for-upgrading-smart-contracts}

1. 使用安全的存取控制/授權機制來避免未經授權的智慧合約升級，尤其是在使用代理模式、策略模式或資料分離時。 例如，限制升級方法的權限，只有合約的所有者可以呼叫升級方法

2. 升級合約是一個複雜的行動，需要高度的謹慎避免引入漏洞

3. 透過去中心化的方法升級實作，減少信任假設 可能的策略包括使用[多重簽名錢包合約](/developers/docs/smart-contracts/#multisig)來控制升級，或要求[去中心化自治組織的成員](/dao/)投票批准升級。

4. 注意升級合約的相關花費， 例如，在合約遷移期間從原有合約複製狀態 (如用戶餘額) 到新合約可能會需要不止一筆交易，這意味著更多燃料費。

5. 考慮實作**時間鎖**來保護使用者， 時間鎖代表，可以延遲升級對於系統的改變， 時間鎖定可以與多重簽名治理系統相結合來控制升級: 如果一個提議的行爲達到了所需的批准門檻，它還需要等到預定義的延遲期過去之後才會執行。

如果使用者不同意未來更新的計劃（例如：邏輯合約升級或新的費用模型），時間鎖給予使用者一些可以退出系統的時間， 沒有時間鎖，使用者必須相信開發者不會在未提前通知的情況下，在合約上進行任意的變更， 缺點是，時間鎖限制了快速修漏洞的能力。

## 資源 {#resources}

**OpenZeppelin 升級外掛 - _一系列部署與保障安全升級合約的工具_**

- [GitHub](https://github.com/OpenZeppelin/openzeppelin-upgrades)
- [文件](https://docs.openzeppelin.com/upgrades)

## 教學 {#tutorials}

- [升級你的智慧合約 | YouTube 使用教學](https://www.youtube.com/watch?v=bdXJmWajZRY) - Patrick Collins
- [以太坊智慧合約遷移教學](https://medium.com/coinmonks/ethereum-smart-contract-migration-13f6f12539bd)by Austin Griffith
- [使用UUPS代理模式升級合約](https://blog.logrocket.com/author/praneshas/)by Pranesh A.S
- [Web3使用教學:使用OpenZeppelin寫一個可升級的智慧合約（代理）](https://dev.to/yakult/tutorial-write-upgradeable-smart-contract-proxy-contract-with-openzeppelin-1916)by fangjun.eth

## 了解更多 {#further-reading}

- [The State of Smart Contract Upgrades](https://blog.openzeppelin.com/the-state-of-smart-contract-upgrades/) by Santiago Palladino
- [多種升級Solidity合約的方法](https://cryptomarketpool.com/multiple-ways-to-upgrade-a-solidity-smart-contract/) - Crypto Market Pool blog
- [學習：升級智慧合約](https://docs.openzeppelin.com/learn/upgrading-smart-contracts)- OpenZeppelin Docs
- [代理模式對於Solidity合約升級能力: Transparent vs UUPS Proxies ](https://mirror.xyz/0xB38709B8198d147cc9Ff9C133838a044d78B064B/M7oTptQkBGXxox-tk9VJjL66E1V8BUF0GF79MMK4YG0)by Naveen Sahu
- [鑽石升級如何運作](https://dev.to/mudgen/how-diamond-upgrades-work-417j)by Nick Mudge
